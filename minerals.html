<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Coffee Water Calculator</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Settings</h1>
    <p class="subtitle">Select the minerals you have on hand and set your starting water</p>
  </header>

  <main>
    <!-- Available Minerals -->
    <section class="card">
      <h2>Available Minerals</h2>
      <p class="hint">Check the minerals you have. These will appear on the other pages.</p>
      <div class="mineral-list" id="mineral-list">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Alkalinity Source -->
    <section class="card">
      <h2>Alkalinity source</h2>
      <p class="hint">Select which mineral to use for alkalinity. You must have at least one of these checked above.</p>
      <div class="alkalinity-source-options">
        <label class="alkalinity-option">
          <input type="radio" name="alkalinity-source" value="baking-soda">
          <span>Baking Soda (NaHCO₃)</span>
        </label>
        <label class="alkalinity-option">
          <input type="radio" name="alkalinity-source" value="potassium-bicarbonate">
          <span>Potassium Bicarbonate (KHCO₃)</span>
        </label>
      </div>
      <p class="hint error" id="alkalinity-warning" style="display:none; margin-top:0.75rem;">No alkalinity source is selected above. The Calculator needs at least Baking Soda or Potassium Bicarbonate checked.</p>
    </section>

    <!-- Source Water Profile -->
    <section class="card">
      <h2>My Starting Water</h2>
      <p class="hint">Enter your tap or base water profile. This will be used as the starting point across all pages. If using distilled or RO water, leave everything at 0.</p>

      <div class="source-presets" id="source-presets">
        <!-- Populated by JS -->
      </div>
      <div class="restore-bar" id="restore-source-bar" style="display:none;">
        <span>Some built-in presets were deleted.</span>
        <a href="#" id="restore-source-defaults">Restore defaults</a>
      </div>

      <div class="save-bar" id="save-bar" style="display:none;">
        <input type="text" id="profile-name" placeholder="Name this profile..." maxlength="40">
        <button id="save-profile-btn" class="preset-btn">Save</button>
      </div>

      <div class="edit-bar" id="edit-bar" style="display:none;">
        <button id="save-changes-btn" class="preset-btn">Save Changes</button>
      </div>

      <div class="source-grid">
        <div class="input-group">
          <label for="src-calcium">Calcium (mg/L)</label>
          <input type="number" id="src-calcium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-magnesium">Magnesium (mg/L)</label>
          <input type="number" id="src-magnesium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-potassium">Potassium (mg/L)</label>
          <input type="number" id="src-potassium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-sodium">Sodium (mg/L)</label>
          <input type="number" id="src-sodium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-sulfate">Sulfate (mg/L)</label>
          <input type="number" id="src-sulfate" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-chloride">Chloride (mg/L)</label>
          <input type="number" id="src-chloride" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-bicarbonate">Bicarbonate (mg/L)</label>
          <input type="number" id="src-bicarbonate" value="0" min="0" step="0.1">
        </div>
      </div>

      <div class="save-status" id="save-status"></div>
    </section>
  </main>

  <div class="confirm-overlay" id="confirm-overlay" style="display:none;">
    <div class="confirm-dialog">
      <p id="confirm-message"></p>
      <div class="confirm-actions">
        <button id="confirm-yes" class="preset-btn">Yes</button>
        <button id="confirm-no" class="preset-btn">No</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Your selections are saved automatically and shared across all pages.</p>
  </footer>

  <script src="shared.js"></script>
  <script>
    const presetsContainer = document.getElementById("source-presets");
    const saveBar = document.getElementById("save-bar");
    const editBar = document.getElementById("edit-bar");
    const profileNameInput = document.getElementById("profile-name");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const saveChangesBtn = document.getElementById("save-changes-btn");


    let activePreset = loadSourcePresetName();

    // --- Populate mineral list ---
    const mineralListEl = document.getElementById("mineral-list");
    const selectedMinerals = loadSelectedMinerals();

    for (const [id, mineral] of Object.entries(MINERAL_DB)) {
      const checked = selectedMinerals.includes(id);
      const div = document.createElement("div");
      div.className = "mineral-item" + (checked ? " selected" : "");
      div.innerHTML = `
        <label class="mineral-label">
          <input type="checkbox" value="${id}" ${checked ? "checked" : ""}>
          <div class="mineral-info">
            <span class="mineral-name">${mineral.name}</span>
            <span class="mineral-formula">${mineral.formula}</span>
            <span class="mineral-desc">${mineral.description}</span>
          </div>
        </label>
      `;
      mineralListEl.appendChild(div);
    }

    // --- Handle mineral selection ---
    function updateAlkalinityWarning() {
      const checked = mineralListEl.querySelectorAll("input:checked");
      const ids = Array.from(checked).map(cb => cb.value);
      const hasBs = ids.includes("baking-soda");
      const hasPb = ids.includes("potassium-bicarbonate");
      const hasAlk = hasBs || hasPb;
      document.getElementById("alkalinity-warning").style.display = hasAlk ? "none" : "block";

      // Sync radio button enabled state with mineral checkboxes
      const bsRadio = document.querySelector('input[name="alkalinity-source"][value="baking-soda"]');
      const pbRadio = document.querySelector('input[name="alkalinity-source"][value="potassium-bicarbonate"]');
      bsRadio.disabled = !hasBs;
      pbRadio.disabled = !hasPb;
      bsRadio.closest(".alkalinity-option").style.opacity = hasBs ? "1" : "0.4";
      pbRadio.closest(".alkalinity-option").style.opacity = hasPb ? "1" : "0.4";

      // Auto-switch if current selection was unchecked
      if (bsRadio.checked && !hasBs && hasPb) {
        pbRadio.checked = true;
        saveAlkalinitySource("potassium-bicarbonate");
      } else if (pbRadio.checked && !hasPb && hasBs) {
        bsRadio.checked = true;
        saveAlkalinitySource("baking-soda");
      }
    }

    mineralListEl.addEventListener("change", (e) => {
      if (e.target.type !== "checkbox") return;
      const item = e.target.closest(".mineral-item");
      item.classList.toggle("selected", e.target.checked);

      const checked = mineralListEl.querySelectorAll("input:checked");
      const ids = Array.from(checked).map(cb => cb.value);
      saveSelectedMinerals(ids);
      updateAlkalinityWarning();
      showSaved();
    });

    // --- Alkalinity source ---
    const currentAlkSource = loadAlkalinitySource();
    document.querySelector(`input[name="alkalinity-source"][value="${currentAlkSource}"]`).checked = true;
    document.querySelectorAll('input[name="alkalinity-source"]').forEach(radio => {
      radio.addEventListener("change", () => {
        saveAlkalinitySource(radio.value);
        showSaved();
      });
    });

    // --- Restore defaults for source water presets ---
    function updateRestoreSourceBar() {
      const deleted = loadDeletedPresets();
      document.getElementById("restore-source-bar").style.display = deleted.length > 0 ? "flex" : "none";
    }

    document.getElementById("restore-source-defaults").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("cw_deleted_presets");
      renderPresetButtons();
      updateRestoreSourceBar();
      showSaved();
    });

    // --- Render all preset buttons dynamically ---
    function renderPresetButtons() {
      presetsContainer.innerHTML = "";
      const allPresets = getAllPresets();
      for (const [key, preset] of Object.entries(allPresets)) {
        const btn = document.createElement("button");
        btn.className = "preset-btn";
        btn.dataset.preset = key;
        if (key === "custom") {
          btn.textContent = preset.label;
        } else {
          btn.innerHTML = `${preset.label}<span class="preset-delete" data-delete="${key}">&times;</span>`;
        }
        presetsContainer.appendChild(btn);
      }
      highlightPreset(activePreset);
    }

    function highlightPreset(presetName) {
      presetsContainer.querySelectorAll(".preset-btn").forEach(b => b.classList.remove("active"));
      const btn = presetsContainer.querySelector(`[data-preset="${presetName}"]`);
      if (btn) btn.classList.add("active");
      saveBar.style.display = presetName === "custom" ? "flex" : "none";
      editBar.style.display = "none";
    }

    function activatePreset(presetName) {
      activePreset = presetName;
      highlightPreset(presetName);
      saveSourcePresetName(presetName);

      if (presetName === "custom") return;

      const values = getSourceWaterByPreset(presetName);
      ION_FIELDS.forEach(ion => {
        document.getElementById("src-" + ion).value = values[ion] || 0;
      });
      saveCurrentSource();
    }

    // --- Detect unsaved changes vs active profile ---
    function hasUnsavedChanges() {
      if (activePreset === "custom") return false;
      const presetValues = getSourceWaterByPreset(activePreset);
      return ION_FIELDS.some(ion => {
        const current = parseFloat(document.getElementById("src-" + ion).value) || 0;
        return current !== (presetValues[ion] || 0);
      });
    }

    // --- Event delegation for preset buttons ---
    presetsContainer.addEventListener("click", (e) => {
      // Handle delete
      const deleteKey = e.target.dataset.delete;
      if (deleteKey) {
        e.stopPropagation();
        showConfirm("Are you sure you want to delete this profile?", () => {
          if (SOURCE_PRESETS[deleteKey]) {
            addDeletedPreset(deleteKey);
          }
          deleteCustomProfile(deleteKey);
          renderPresetButtons();
          updateRestoreSourceBar();
          if (activePreset === deleteKey) {
            const remaining = Object.keys(getAllPresets());
            const fallback = remaining.find(k => k !== "custom") || "custom";
            activatePreset(fallback);
          }
        });
        return;
      }

      // Handle preset click
      const btn = e.target.closest(".preset-btn");
      if (!btn) return;
      activatePreset(btn.dataset.preset);
    });

    // --- Source water input changes ---
    ION_FIELDS.forEach(ion => {
      const input = document.getElementById("src-" + ion);
      input.addEventListener("input", () => {
        if (activePreset !== "custom") {
          editBar.style.display = hasUnsavedChanges() ? "flex" : "none";
        }
        saveCurrentSource();
      });
    });

    // --- Save changes to existing profile (with confirmation) ---
    saveChangesBtn.addEventListener("click", () => {
      showConfirm("Are you sure you want to change this profile?", () => {
        const allPresets = getAllPresets();
        const profile = { label: allPresets[activePreset].label };
        ION_FIELDS.forEach(ion => {
          profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
        });
        const profiles = loadCustomProfiles();
        profiles[activePreset] = profile;
        saveCustomProfiles(profiles);
        editBar.style.display = "none";
        renderPresetButtons();
        showSaved();
      });
    });

    // --- Save new custom profile ---
    saveProfileBtn.addEventListener("click", () => {
      const name = profileNameInput.value.trim();
      if (!name) {
        showSaveStatus("Enter a profile name.", true);
        return;
      }

      const key = slugify(name);
      if (!key) {
        showSaveStatus("Enter a valid name.", true);
        return;
      }
      if (SOURCE_PRESETS[key]) {
        showSaveStatus("That name is reserved. Choose a different name.", true);
        return;
      }
      const customProfiles = loadCustomProfiles();
      if (customProfiles[key]) {
        showSaveStatus("A profile with this name already exists.", true);
        return;
      }
      const existingLabels = getExistingSourceProfileLabels();
      if (existingLabels.has(name.trim().toLowerCase())) {
        showSaveStatus("A profile with this name already exists.", true);
        return;
      }

      const profile = { label: name };
      ION_FIELDS.forEach(ion => {
        profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
      });

      customProfiles[key] = profile;
      saveCustomProfiles(customProfiles);

      renderPresetButtons();
      activatePreset(key);

      profileNameInput.value = "";
      showSaveStatus("Saved!", false);
    });

    // --- Initialize ---
    const sourceWater = loadSourceWater();
    ION_FIELDS.forEach(ion => {
      document.getElementById("src-" + ion).value = sourceWater[ion] || 0;
    });

    renderPresetButtons();
    updateRestoreSourceBar();
    updateAlkalinityWarning();

    // If saved preset was deleted, fall back
    const allPresets = getAllPresets();
    if (!allPresets[activePreset]) {
      const fallback = Object.keys(allPresets).find(k => k !== "custom") || "custom";
      activatePreset(fallback);
    }

    function saveCurrentSource() {
      const profile = {};
      ION_FIELDS.forEach(ion => {
        profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
      });
      saveSourceWater(profile);
    }

    function showSaveStatus(message, isError) {
      const el = document.getElementById("save-status");
      el.textContent = message;
      el.classList.toggle("error", isError);
      el.classList.add("visible");
      setTimeout(() => {
        el.classList.remove("visible", "error");
      }, isError ? 3000 : 1500);
    }

    function showSaved() {
      showSaveStatus("Saved!", false);
    }
  </script>
</body>
</html>
