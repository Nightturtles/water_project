<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Coffee Water Calculator</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="style.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BGJWVRGJJC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BGJWVRGJJC');
  </script>
  <script src="theme-init.js"></script>
</head>
<body>
  <header>
    <h1>Settings</h1>
    <p class="subtitle">Select the minerals you have on hand and configure app preferences</p>
  </header>

  <main>
    <!-- Available Minerals (collapsible; hint always visible) -->
    <section class="card card-collapsible">
      <button type="button" class="card-collapsible-summary" id="available-minerals-summary" aria-expanded="true" aria-controls="available-minerals-content">
        <span class="card-collapsible-title">Available Minerals</span>
      </button>
      <p class="hint">Check the minerals you have. These will appear on the other pages.</p>
      <div class="card-collapsible-content" id="available-minerals-content">
        <div class="mineral-list" id="mineral-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </section>

    <!-- Available Concentrates -->
    <section class="card">
      <h2>Available Concentrates</h2>

      <button type="button" class="card-collapsible-summary" id="diy-concentrates-summary" aria-expanded="true" aria-controls="diy-concentrates-content">
        <span class="card-collapsible-title">DIY Concentrates</span>
      </button>
      <p class="hint">All concentrates assumed to be made with Distilled / RO water</p>
      <div class="card-collapsible-content" id="diy-concentrates-content">
        <div class="concentrate-list" id="diy-concentrate-list">
          <!-- Populated by JS -->
        </div>
      </div>

      <button type="button" class="card-collapsible-summary" id="brand-concentrates-summary" aria-expanded="false" aria-controls="brand-concentrates-content">
        <span class="card-collapsible-title">Brand Name Concentrates</span>
      </button>
      <p class="hint">Coming soon.</p>
      <div class="card-collapsible-content" id="brand-concentrates-content">
        <p class="hint">Coming soon.</p>
      </div>
    </section>

    <section class="card">
      <h2>Mineral Display Mode</h2>
      <p class="hint">Choose how much detail to show across the app.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="mineral-display-mode" value="standard">
          <span>Standard Minerals</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="mineral-display-mode" value="advanced">
          <span>Advanced Minerals</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Theme</h2>
      <p class="hint">Choose light, dark, or follow your device setting.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="theme" value="light">
          <span>Light Mode</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="theme" value="dark">
          <span>Dark Mode</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="theme" value="system">
          <span>System</span>
          <span class="theme-helper-inline">Follows your device setting.</span>
        </label>
      </div>
    </section>

    <div class="save-status" id="save-status" aria-live="polite"></div>
  </main>

  <div class="confirm-overlay" id="confirm-overlay" style="display:none;">
    <div class="confirm-dialog">
      <p id="confirm-message"></p>
      <div class="confirm-actions">
        <button id="confirm-yes" class="preset-btn">Yes</button>
        <button id="confirm-no" class="preset-btn">No</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Your selections are saved automatically and shared across all pages.</p>
    <p>For feedback or questions send an email to info@cafelytic.com</p>
  </footer>

  <script src="constants.js"></script>
  <script src="storage.js"></script>
  <script src="metrics.js"></script>
  <script src="ui-shared.js"></script>
  <script>
    const mineralDisplayModeInputs = document.querySelectorAll('input[name="mineral-display-mode"]');
    const showSaveStatus = createStatusHandler(document.getElementById("save-status"));

    // --- Populate mineral list ---
    const mineralListEl = document.getElementById("mineral-list");
    const selectedMinerals = loadSelectedMinerals();

    for (const [id, mineral] of Object.entries(MINERAL_DB)) {
      const checked = selectedMinerals.includes(id);
      const div = document.createElement("div");
      div.className = "mineral-item" + (checked ? " selected" : "");
      const label = document.createElement("label");
      label.className = "mineral-label";
      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = id;
      if (checked) input.checked = true;
      const info = document.createElement("div");
      info.className = "mineral-info";
      const nameSpan = document.createElement("span");
      nameSpan.className = "mineral-name";
      nameSpan.textContent = mineral.name;
      const formulaSpan = document.createElement("span");
      formulaSpan.className = "mineral-formula";
      formulaSpan.textContent = mineral.formula;
      const descSpan = document.createElement("span");
      descSpan.className = "mineral-desc";
      descSpan.textContent = mineral.description;
      info.appendChild(nameSpan);
      info.appendChild(formulaSpan);
      info.appendChild(descSpan);
      label.appendChild(input);
      label.appendChild(info);
      div.appendChild(label);
      mineralListEl.appendChild(div);
    }

    // --- Handle mineral-source availability and auto-selection ---
    mineralListEl.addEventListener("change", (e) => {
      if (e.target.type !== "checkbox") return;
      const item = e.target.closest(".mineral-item");
      item.classList.toggle("selected", e.target.checked);

      const checked = mineralListEl.querySelectorAll("input:checked");
      const ids = Array.from(checked).map(cb => cb.value);
      saveSelectedMinerals(ids);
      showSaved();
    });

    // --- DIY concentrates ---
    const diyListEl = document.getElementById("diy-concentrate-list");
    const selectedConcentrates = loadSelectedConcentrates();
    const diySpecs = loadDiyConcentrateSpecs();

    function getSolubilityLimitGPerL(mineralId) {
      const v = MINERAL_SOLUBILITY_G_PER_L_25C_APPROX ? MINERAL_SOLUBILITY_G_PER_L_25C_APPROX[mineralId] : null;
      return Number.isFinite(Number(v)) ? Number(v) : null;
    }

    function updateDiySolubilityWarning(mineralId, itemEl) {
      if (!itemEl) return;
      const bottleEl = itemEl.querySelector('input[data-field="bottle-ml"]');
      const gramsEl = itemEl.querySelector('input[data-field="grams-per-bottle"]');
      const warningEl = itemEl.querySelector(".concentrate-warning");
      if (!bottleEl || !gramsEl || !warningEl) return;

      const bottleMl = Math.max(0, parseFloat(bottleEl.value) || 0);
      const gramsPerBottle = Math.max(0, parseFloat(gramsEl.value) || 0);
      const limit = getSolubilityLimitGPerL(mineralId);
      if (!bottleMl || bottleMl <= 0 || !gramsPerBottle || gramsPerBottle <= 0 || limit == null) {
        warningEl.style.display = "none";
        return;
      }
      const gPerL = gramsPerBottle / (bottleMl / 1000);
      warningEl.style.display = gPerL >= limit ? "" : "none";
    }

    function renderDiyConcentrates() {
      if (!diyListEl) return;
      diyListEl.innerHTML = "";
      for (const [mineralId, mineral] of Object.entries(MINERAL_DB)) {
        const concentrateId = "diy:" + mineralId;
        const checked = selectedConcentrates.includes(concentrateId);
        const spec = diySpecs && diySpecs[mineralId] ? diySpecs[mineralId] : {};
        const bottleMl = Number.isFinite(Number(spec.bottleMl)) ? Number(spec.bottleMl) : 0;
        const gramsPerBottle = Number.isFinite(Number(spec.gramsPerBottle)) ? Number(spec.gramsPerBottle) : 0;

        const div = document.createElement("div");
        div.className = "concentrate-item" + (checked ? " selected" : "");
        div.dataset.mineralId = mineralId;
        div.innerHTML = `
          <label class="concentrate-label">
            <input type="checkbox" value="${concentrateId}" ${checked ? "checked" : ""}>
            <div class="concentrate-info">
              <span class="mineral-name">${mineral.name}</span>
              <span class="mineral-formula">${mineral.formula}</span>
            </div>
          </label>
          <div class="concentrate-inputs">
            <div class="input-group">
              <label>Bottle mL</label>
              <input type="number" min="0" step="1" value="${bottleMl}" data-field="bottle-ml">
            </div>
            <div class="input-group">
              <label>Grams per bottle</label>
              <input type="number" min="0" step="0.01" value="${gramsPerBottle}" data-field="grams-per-bottle">
            </div>
          </div>
          <div class="concentrate-warning" style="display:none;">Youâ€™ve reached the solubility limit for this mineral, try a lower concentration.</div>
        `;
        diyListEl.appendChild(div);
        updateDiySolubilityWarning(mineralId, div);
      }
    }

    renderDiyConcentrates();

    if (diyListEl) {
      diyListEl.addEventListener("change", (e) => {
        if (e.target.type !== "checkbox") return;
        const item = e.target.closest(".concentrate-item");
        if (!item) return;
        item.classList.toggle("selected", e.target.checked);
        updateDiySolubilityWarning(item.dataset.mineralId, item);
        const checked = diyListEl.querySelectorAll('input[type="checkbox"]:checked');
        const diyIds = Array.from(checked).map(cb => cb.value);
        // Keep non-DIY concentrates (future) intact.
        const existing = loadSelectedConcentrates().filter((id) => typeof id === "string" && !id.startsWith("diy:"));
        saveSelectedConcentrates(existing.concat(diyIds));
        showSaved();
      });

      diyListEl.addEventListener("input", (e) => {
        const input = e.target;
        if (!input || input.tagName !== "INPUT") return;
        if (input.type !== "number") return;
        const item = input.closest(".concentrate-item");
        if (!item) return;
        const mineralId = item.dataset.mineralId;
        if (!mineralId) return;

        const bottleEl = item.querySelector('input[data-field="bottle-ml"]');
        const gramsEl = item.querySelector('input[data-field="grams-per-bottle"]');
        const bottleMl = bottleEl ? Math.max(0, parseFloat(bottleEl.value) || 0) : 0;
        const gramsPerBottle = gramsEl ? Math.max(0, parseFloat(gramsEl.value) || 0) : 0;

        const specs = loadDiyConcentrateSpecs();
        specs[mineralId] = { bottleMl, gramsPerBottle };
        saveDiyConcentrateSpecs(specs);
        updateDiySolubilityWarning(mineralId, item);
        showSaved();
      });
    }

    // --- Theme (Bug 6: safe radio selection) ---
    const themeInputs = document.querySelectorAll('input[name="theme"]');
    selectRadioByValue("theme", loadThemePreference());
    themeInputs.forEach(radio => {
      radio.addEventListener("change", () => {
        saveThemePreference(radio.value);
        applyTheme();
        showSaved();
      });
    });

    selectRadioByValue("mineral-display-mode", loadMineralDisplayMode());
    mineralDisplayModeInputs.forEach(radio => {
      radio.addEventListener("change", () => {
        saveMineralDisplayMode(radio.value);
        applyMineralDisplayMode();
        showSaved();
      });
    });

    function showSaved() {
      showSaveStatus("Saved!", false);
    }

    // --- Collapsible: toggle Available Minerals list (hint stays visible) ---
    const availableMineralsSummary = document.getElementById("available-minerals-summary");
    const availableMineralsContent = document.getElementById("available-minerals-content");
    if (availableMineralsSummary && availableMineralsContent) {
      availableMineralsSummary.addEventListener("click", () => {
        const expanded = availableMineralsSummary.getAttribute("aria-expanded") !== "true";
        availableMineralsSummary.setAttribute("aria-expanded", expanded);
      });
    }

    const diySummary = document.getElementById("diy-concentrates-summary");
    const diyContent = document.getElementById("diy-concentrates-content");
    if (diySummary && diyContent) {
      diySummary.addEventListener("click", () => {
        const expanded = diySummary.getAttribute("aria-expanded") !== "true";
        diySummary.setAttribute("aria-expanded", expanded);
      });
    }

    const brandSummary = document.getElementById("brand-concentrates-summary");
    const brandContent = document.getElementById("brand-concentrates-content");
    if (brandSummary && brandContent) {
      brandSummary.addEventListener("click", () => {
        const expanded = brandSummary.getAttribute("aria-expanded") !== "true";
        brandSummary.setAttribute("aria-expanded", expanded);
      });
    }

    // --- Refresh on bfcache restore ---
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) location.reload();
    });
  </script>
</body>
</html>
