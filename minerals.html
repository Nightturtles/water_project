<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - Coffee Water Calculator</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="stylesheet" href="style.css">
  <script src="theme-init.js"></script>
</head>
<body>
  <header>
    <h1>Settings</h1>
    <p class="subtitle">Select the minerals you have on hand and set your starting water</p>
  </header>

  <main>
    <!-- Source Water Profile -->
    <section class="card">
      <h2>My Starting Water</h2>
      <p class="hint">Enter your tap or base water profile. This will be used as the starting point across all pages. If using distilled or RO water, leave everything at 0.</p>

      <div class="source-presets" id="source-presets">
        <!-- Populated by JS -->
      </div>
      <div class="restore-bar" id="restore-source-bar" style="display:none;">
        <span>Some built-in presets were deleted.</span>
        <a href="#" id="restore-source-defaults">Restore defaults</a>
      </div>

      <div class="save-bar" id="save-bar" style="display:none;">
        <div class="name-field">
          <input type="text" id="profile-name" placeholder="Name this profile..." maxlength="40">
          <div class="profile-name-error" id="profile-name-error" aria-live="polite"></div>
        </div>
        <button id="save-profile-btn" class="preset-btn">Save</button>
      </div>

      <div class="edit-bar" id="edit-bar" style="display:none;">
        <span class="edit-bar-label" id="edit-bar-label">Editing:</span>
        <button id="save-changes-btn" class="preset-btn">Save Changes</button>
      </div>

      <div class="source-grid">
        <div class="input-group">
          <label for="src-calcium">Calcium (mg/L)</label>
          <input type="number" id="src-calcium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-magnesium">Magnesium (mg/L)</label>
          <input type="number" id="src-magnesium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group">
          <label for="src-alkalinity">Alkalinity (mg/L as CaCO₃)</label>
          <input type="number" id="src-alkalinity" value="0" min="0" step="1">
        </div>
        <div class="input-group advanced-only">
          <label for="src-potassium">Potassium (mg/L)</label>
          <input type="number" id="src-potassium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group advanced-only">
          <label for="src-sodium">Sodium (mg/L)</label>
          <input type="number" id="src-sodium" value="0" min="0" step="0.1">
        </div>
        <div class="input-group advanced-only">
          <label for="src-sulfate">Sulfate (mg/L)</label>
          <input type="number" id="src-sulfate" value="0" min="0" step="0.1">
        </div>
        <div class="input-group advanced-only">
          <label for="src-chloride">Chloride (mg/L)</label>
          <input type="number" id="src-chloride" value="0" min="0" step="0.1">
        </div>
        <div class="input-group always-hidden">
          <label for="src-bicarbonate">Bicarbonate (mg/L)</label>
          <input type="number" id="src-bicarbonate" value="0" min="0" step="0.1">
        </div>
      </div>

      <div class="save-status" id="save-status" aria-live="polite"></div>
    </section>

    <!-- Available Minerals -->
    <section class="card">
      <h2>Available Minerals</h2>
      <p class="hint">Check the minerals you have. These will appear on the other pages.</p>
      <div class="mineral-list" id="mineral-list">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- Alkalinity Source -->
    <section class="card">
      <h2>Alkalinity source</h2>
      <p class="hint">Select which mineral to use for alkalinity. You must have at least one of these checked above.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="alkalinity-source" value="baking-soda">
          <span>Baking Soda (NaHCO₃)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="alkalinity-source" value="potassium-bicarbonate">
          <span>Potassium Bicarbonate (KHCO₃)</span>
        </label>
      </div>
      <p class="hint error" id="alkalinity-warning" style="display:none; margin-top:0.75rem;">No alkalinity source is selected above. The Calculator needs at least Baking Soda or Potassium Bicarbonate checked.</p>
    </section>

    <section class="card">
      <h2>Calcium source</h2>
      <p class="hint">Select which mineral to use for calcium. You must have at least one of these checked above.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="calcium-source" value="calcium-chloride">
          <span>Calcium Chloride (CaCl₂·2H₂O)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="calcium-source" value="gypsum">
          <span>Gypsum (CaSO₄·2H₂O)</span>
        </label>
      </div>
      <p class="hint error" id="calcium-warning" style="display:none; margin-top:0.75rem;">No calcium source is selected above. The Calculator needs at least Calcium Chloride or Gypsum checked.</p>
    </section>

    <section class="card">
      <h2>Magnesium source</h2>
      <p class="hint">Select which mineral to use for magnesium. You must have at least one of these checked above.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="magnesium-source" value="epsom-salt">
          <span>Epsom Salt (MgSO₄·7H₂O)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="magnesium-source" value="magnesium-chloride">
          <span>Magnesium Chloride (MgCl₂·6H₂O)</span>
        </label>
      </div>
      <p class="hint error" id="magnesium-warning" style="display:none; margin-top:0.75rem;">No magnesium source is selected above. The Calculator needs at least Epsom Salt or Magnesium Chloride checked.</p>
    </section>

    <section class="card">
      <h2>Mineral Display Mode</h2>
      <p class="hint">Choose how much detail to show across the app.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="mineral-display-mode" value="standard">
          <span>Standard Minerals</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="mineral-display-mode" value="advanced">
          <span>Advanced Minerals</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Theme</h2>
      <p class="hint">Choose light, dark, or follow your device setting.</p>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="theme" value="light">
          <span>Light Mode</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="theme" value="dark">
          <span>Dark Mode</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="theme" value="system">
          <span>System</span>
          <span class="theme-helper-inline">Follows your device setting.</span>
        </label>
      </div>
    </section>

  </main>

  <div class="confirm-overlay" id="confirm-overlay" style="display:none;">
    <div class="confirm-dialog">
      <p id="confirm-message"></p>
      <div class="confirm-actions">
        <button id="confirm-yes" class="preset-btn">Yes</button>
        <button id="confirm-no" class="preset-btn">No</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Your selections are saved automatically and shared across all pages.</p>
  </footer>

  <script src="constants.js"></script>
  <script src="storage.js"></script>
  <script src="metrics.js"></script>
  <script src="ui-shared.js"></script>
  <script>
    const presetsContainer = document.getElementById("source-presets");
    const saveBar = document.getElementById("save-bar");
    const editBar = document.getElementById("edit-bar");
    const profileNameInput = document.getElementById("profile-name");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const saveChangesBtn = document.getElementById("save-changes-btn");
    const mineralDisplayModeInputs = document.querySelectorAll('input[name="mineral-display-mode"]');


    let activePreset = loadSourcePresetName();

    // --- Populate mineral list ---
    const mineralListEl = document.getElementById("mineral-list");
    const selectedMinerals = loadSelectedMinerals();

    for (const [id, mineral] of Object.entries(MINERAL_DB)) {
      const checked = selectedMinerals.includes(id);
      const div = document.createElement("div");
      div.className = "mineral-item" + (checked ? " selected" : "");
      div.innerHTML = `
        <label class="mineral-label">
          <input type="checkbox" value="${id}" ${checked ? "checked" : ""}>
          <div class="mineral-info">
            <span class="mineral-name">${mineral.name}</span>
            <span class="mineral-formula">${mineral.formula}</span>
            <span class="mineral-desc">${mineral.description}</span>
          </div>
        </label>
      `;
      mineralListEl.appendChild(div);
    }

    // --- Handle mineral-source availability and auto-selection ---
    function updateMineralSourceWarnings() {
      const checked = mineralListEl.querySelectorAll("input:checked");
      const ids = Array.from(checked).map(cb => cb.value);

      const hasBs = ids.includes("baking-soda");
      const hasPb = ids.includes("potassium-bicarbonate");
      const hasAlk = hasBs || hasPb;
      document.getElementById("alkalinity-warning").style.display = hasAlk ? "none" : "block";

      const bsRadio = document.querySelector('input[name="alkalinity-source"][value="baking-soda"]');
      const pbRadio = document.querySelector('input[name="alkalinity-source"][value="potassium-bicarbonate"]');
      bsRadio.disabled = !hasBs;
      pbRadio.disabled = !hasPb;
      bsRadio.closest(".radio-option").style.opacity = hasBs ? "1" : "0.4";
      pbRadio.closest(".radio-option").style.opacity = hasPb ? "1" : "0.4";
      if (hasAlk) {
        const effectiveAlk = getEffectiveAlkalinitySource();
        if (effectiveAlk === "potassium-bicarbonate") {
          pbRadio.checked = true;
          saveAlkalinitySource("potassium-bicarbonate");
        } else {
          bsRadio.checked = true;
          saveAlkalinitySource("baking-soda");
        }
      }

      const hasCaCl2 = ids.includes("calcium-chloride");
      const hasGypsum = ids.includes("gypsum");
      const hasCa = hasCaCl2 || hasGypsum;
      document.getElementById("calcium-warning").style.display = hasCa ? "none" : "block";
      const cacl2Radio = document.querySelector('input[name="calcium-source"][value="calcium-chloride"]');
      const gypsumRadio = document.querySelector('input[name="calcium-source"][value="gypsum"]');
      cacl2Radio.disabled = !hasCaCl2;
      gypsumRadio.disabled = !hasGypsum;
      cacl2Radio.closest(".radio-option").style.opacity = hasCaCl2 ? "1" : "0.4";
      gypsumRadio.closest(".radio-option").style.opacity = hasGypsum ? "1" : "0.4";
      if (hasCa) {
        const effectiveCa = getEffectiveCalciumSource();
        if (effectiveCa === "gypsum") {
          gypsumRadio.checked = true;
          saveCalciumSource("gypsum");
        } else {
          cacl2Radio.checked = true;
          saveCalciumSource("calcium-chloride");
        }
      }

      const hasEpsom = ids.includes("epsom-salt");
      const hasMgCl2 = ids.includes("magnesium-chloride");
      const hasMg = hasEpsom || hasMgCl2;
      document.getElementById("magnesium-warning").style.display = hasMg ? "none" : "block";
      const epsomRadio = document.querySelector('input[name="magnesium-source"][value="epsom-salt"]');
      const mgcl2Radio = document.querySelector('input[name="magnesium-source"][value="magnesium-chloride"]');
      epsomRadio.disabled = !hasEpsom;
      mgcl2Radio.disabled = !hasMgCl2;
      epsomRadio.closest(".radio-option").style.opacity = hasEpsom ? "1" : "0.4";
      mgcl2Radio.closest(".radio-option").style.opacity = hasMgCl2 ? "1" : "0.4";
      if (hasMg) {
        const effectiveMg = getEffectiveMagnesiumSource();
        if (effectiveMg === "magnesium-chloride") {
          mgcl2Radio.checked = true;
          saveMagnesiumSource("magnesium-chloride");
        } else {
          epsomRadio.checked = true;
          saveMagnesiumSource("epsom-salt");
        }
      }
    }

    mineralListEl.addEventListener("change", (e) => {
      if (e.target.type !== "checkbox") return;
      const item = e.target.closest(".mineral-item");
      item.classList.toggle("selected", e.target.checked);

      const checked = mineralListEl.querySelectorAll("input:checked");
      const ids = Array.from(checked).map(cb => cb.value);
      saveSelectedMinerals(ids);
      updateMineralSourceWarnings();
      showSaved();
    });

    // --- Theme (Bug 6: safe radio selection) ---
    const themeInputs = document.querySelectorAll('input[name="theme"]');
    selectRadioByValue("theme", loadThemePreference());
    themeInputs.forEach(radio => {
      radio.addEventListener("change", () => {
        saveThemePreference(radio.value);
        applyTheme();
        showSaved();
      });
    });

    selectRadioByValue("mineral-display-mode", loadMineralDisplayMode());
    mineralDisplayModeInputs.forEach(radio => {
      radio.addEventListener("change", () => {
        saveMineralDisplayMode(radio.value);
        applyMineralDisplayMode();
        showSaved();
      });
    });

    // --- Alkalinity source (Bug 6: safe radio selection) ---
    selectRadioByValue("alkalinity-source", loadAlkalinitySource());
    document.querySelectorAll('input[name="alkalinity-source"]').forEach(radio => {
      radio.addEventListener("change", () => {
        saveAlkalinitySource(radio.value);
        showSaved();
      });
    });

    // --- Calcium source (Bug 6: safe radio selection) ---
    selectRadioByValue("calcium-source", loadCalciumSource());
    document.querySelectorAll('input[name="calcium-source"]').forEach(radio => {
      radio.addEventListener("change", () => {
        saveCalciumSource(radio.value);
        showSaved();
      });
    });

    // --- Magnesium source (Bug 6: safe radio selection) ---
    selectRadioByValue("magnesium-source", loadMagnesiumSource());
    document.querySelectorAll('input[name="magnesium-source"]').forEach(radio => {
      radio.addEventListener("change", () => {
        saveMagnesiumSource(radio.value);
        showSaved();
      });
    });

    // --- Restore defaults for source water presets (uses shared updateRestoreSourceBar) ---
    document.getElementById("restore-source-defaults").addEventListener("click", (e) => {
      e.preventDefault();
      restoreSourcePresetDefaults();
      renderPresetButtons();
      updateRestoreSourceBar();
      showSaved();
    });

    // --- Render all preset buttons dynamically (Inefficiency 1: cleaned up) ---
    function renderPresetButtons() {
      presetsContainer.innerHTML = "";
      const allPresets = getAllPresets();
      for (const [key, preset] of Object.entries(allPresets)) {
        const btn = document.createElement("button");
        btn.className = "preset-btn";
        btn.dataset.preset = key;
        btn.textContent = preset.label;
        if (key !== "custom") {
          const del = document.createElement("span");
          del.className = "preset-delete";
          del.dataset.delete = key;
          del.innerHTML = "&times;";
          btn.appendChild(del);
        }
        presetsContainer.appendChild(btn);
      }
      highlightPreset(activePreset);
    }

    const srcAlkalinityInput = document.getElementById("src-alkalinity");
    const srcBicarbonateInput = document.getElementById("src-bicarbonate");

    function updateAlkalinityFromBicarbonate() {
      const bicarb = parseFloat(srcBicarbonateInput.value) || 0;
      srcAlkalinityInput.value = Math.round(bicarb * HCO3_TO_CACO3);
    }

    srcAlkalinityInput.addEventListener("input", () => {
      const alkAsCaCO3 = parseFloat(srcAlkalinityInput.value) || 0;
      srcBicarbonateInput.value = toStableBicarbonateFromAlkalinity(alkAsCaCO3, srcBicarbonateInput.value);
      srcBicarbonateInput.dispatchEvent(new Event("input", { bubbles: true }));
    });

    function highlightPreset(presetName) {
      presetsContainer.querySelectorAll(".preset-btn").forEach(b => b.classList.remove("active"));
      const btn = presetsContainer.querySelector(`[data-preset="${presetName}"]`);
      if (btn) btn.classList.add("active");
      saveBar.style.display = presetName === "custom" ? "flex" : "none";
      editBar.style.display = "none";
    }

    function activatePreset(presetName) {
      activePreset = presetName;
      highlightPreset(presetName);
      saveSourcePresetName(presetName);

      if (presetName === "custom") return;

      const values = getSourceWaterByPreset(presetName);
      ION_FIELDS.forEach(ion => {
        document.getElementById("src-" + ion).value = values[ion] || 0;
      });
      saveCurrentSource();
      updateAlkalinityFromBicarbonate();
    }

    // --- Detect unsaved changes vs active profile ---
    function hasUnsavedChanges() {
      if (activePreset === "custom") return false;
      const presetValues = getSourceWaterByPreset(activePreset);
      return ION_FIELDS.some(ion => {
        const current = parseFloat(document.getElementById("src-" + ion).value) || 0;
        return current !== (presetValues[ion] || 0);
      });
    }

    // --- Event delegation for preset buttons ---
    presetsContainer.addEventListener("click", (e) => {
      // Handle delete
      const deleteKey = e.target.dataset.delete;
      if (deleteKey) {
        e.stopPropagation();
        showConfirm("Are you sure you want to delete this profile?", () => {
          if (SOURCE_PRESETS[deleteKey]) {
            addDeletedPreset(deleteKey);
          }
          deleteCustomProfile(deleteKey);
          renderPresetButtons();
          updateRestoreSourceBar();
          if (activePreset === deleteKey) {
            const remaining = Object.keys(getAllPresets());
            const fallback = remaining.find(k => k !== "custom") || "custom";
            activatePreset(fallback);
          }
        });
        return;
      }

      // Handle preset click
      const btn = e.target.closest(".preset-btn");
      if (!btn) return;
      activatePreset(btn.dataset.preset);
    });

    // --- Source water input changes ---
    ION_FIELDS.forEach(ion => {
      const input = document.getElementById("src-" + ion);
      input.addEventListener("input", () => {
        if (activePreset !== "custom") {
          const showEdit = hasUnsavedChanges();
          editBar.style.display = showEdit ? "flex" : "none";
          if (showEdit) {
            const preset = getAllPresets()[activePreset];
            document.getElementById("edit-bar-label").textContent =
              "Editing: " + (preset && preset.label ? preset.label : activePreset);
          }
        }
        saveCurrentSource();
        updateAlkalinityFromBicarbonate();
      });
    });

    // --- Save changes to existing profile (with confirmation) ---
    saveChangesBtn.addEventListener("click", () => {
      showConfirm("Are you sure you want to change this profile?", () => {
        const allPresets = getAllPresets();
        const existing = allPresets[activePreset];
        if (!existing) return;
        const profile = { label: existing.label };
        ION_FIELDS.forEach(ion => {
          profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
        });
        const profiles = loadCustomProfiles();
        profiles[activePreset] = profile;
        saveCustomProfiles(profiles);
        editBar.style.display = "none";
        renderPresetButtons();
        showSaved();
      });
    });

    // --- Duplicate name error below name input ---
    function updateProfileNameError() {
      const errEl = document.getElementById("profile-name-error");
      const validation = validateProfileName(profileNameInput.value, {
        allowEmpty: true,
        builtinKeys: new Set(Object.keys(SOURCE_PRESETS)),
        existingKeys: new Set(Object.keys(loadCustomProfiles())),
        existingLabels: getExistingSourceProfileLabels()
      });
      if (validation.empty) {
        errEl.textContent = "";
        saveProfileBtn.disabled = false;
        return;
      }
      if (!validation.ok) {
        errEl.textContent = validation.message;
        saveProfileBtn.disabled = true;
        return;
      }
      errEl.textContent = "";
      saveProfileBtn.disabled = false;
    }

    profileNameInput.addEventListener("input", updateProfileNameError);
    bindEnterToClick(profileNameInput, saveProfileBtn);

    // --- Save new custom profile ---
    saveProfileBtn.addEventListener("click", () => {
      const validation = validateProfileName(profileNameInput.value, {
        builtinKeys: new Set(Object.keys(SOURCE_PRESETS)),
        existingKeys: new Set(Object.keys(loadCustomProfiles())),
        existingLabels: getExistingSourceProfileLabels()
      });
      if (!validation.ok) {
        if (validation.code === "reserved" || validation.code === "duplicate") {
          updateProfileNameError();
          return;
        }
        document.getElementById("profile-name-error").textContent = "";
        showSaveStatus(validation.message, true);
        return;
      }
      const { key, name } = validation;
      if (!key || !name) {
        updateProfileNameError();
        return;
      }

      document.getElementById("profile-name-error").textContent = "";

      const customProfiles = loadCustomProfiles();
      const profile = { label: name };
      ION_FIELDS.forEach(ion => {
        profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
      });

      customProfiles[key] = profile;
      saveCustomProfiles(customProfiles);

      renderPresetButtons();
      activatePreset(key);

      profileNameInput.value = "";
      updateProfileNameError();
      showSaveStatus("Saved!", false);
    });

    // --- Initialize ---
    const sourceWater = loadSourceWater();
    ION_FIELDS.forEach(ion => {
      document.getElementById("src-" + ion).value = sourceWater[ion] || 0;
    });

    renderPresetButtons();
    updateAlkalinityFromBicarbonate();
    updateRestoreSourceBar();
    updateMineralSourceWarnings();

    // Sync inputs with active preset (handles cross-page preset changes)
    const allPresets = getAllPresets();
    if (!allPresets[activePreset]) {
      const fallback = Object.keys(allPresets).find(k => k !== "custom") || "custom";
      activatePreset(fallback);
    } else if (activePreset !== "custom") {
      activatePreset(activePreset);
    }

    function saveCurrentSource() {
      const profile = {};
      ION_FIELDS.forEach(ion => {
        profile[ion] = parseFloat(document.getElementById("src-" + ion).value) || 0;
      });
      saveSourceWater(profile);
    }

    const showSaveStatus = createStatusHandler(document.getElementById("save-status"));

    function showSaved() {
      showSaveStatus("Saved!", false);
    }

    // --- Refresh on bfcache restore ---
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) location.reload();
    });
  </script>
</body>
</html>
